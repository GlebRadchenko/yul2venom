# Yul2Venom Transpiler Configuration
# ===================================
# Copy this file to customize transpiler behavior.
# CLI arguments override these settings.

# =============================================================================
# FUNCTION INLINING (venom_generator.py)
# =============================================================================
# Controls when functions are EMITTED as separate callable functions vs INLINED.
# 
# HOW IT WORKS:
# - Functions with statements > stmt_threshold AND calls > call_threshold
#   are emitted as separate functions and called via `invoke`
# - This enables O(1) dispatch via Venom's native djmp jump tables
# - Smaller/less-frequent functions are inlined at each call site
#
# TRADE-OFF:
# - Lower thresholds = more functions emitted = smaller bytecode, slower calls
# - Higher thresholds = more inlining = larger bytecode, faster calls

inlining:
  # Functions with MORE than this many statements may be emitted instead of inlined
  # Tuned default: 4 (best size/gas balance in current corpus)
  stmt_threshold: 4
  
  # Functions called MORE than this many times may be emitted instead of inlined.
  # Tuned default: 0 (emit reused non-trivial helpers quickly).
  call_threshold: 0

  # Always inline helpers with <= N statements, even if call count is high.
  # This trims invoke/ret overhead on hot tiny functions while keeping larger
  # routines eligible for emission to avoid bytecode explosion.
  # Set to 0 to disable.
  always_inline_max_statements: 3
  
  # Set to false to inline everything (except recursive functions which always use invoke)
  enabled: true

# =============================================================================
# YUL SOURCE OPTIMIZER (yul_source_optimizer.py)
# =============================================================================
# Pre-transpilation optimization of Yul source code.
# Runs BEFORE IR generation to simplify the Yul AST.

yul_optimizer:
  # Optimization aggressiveness level:
  # - safe: Only remove clearly dead code (validators, empty blocks)
  # - standard: Remove non-payable checks, basic ABI decoder checks
  # - aggressive: Remove runtime checks (extcodesize, returndatasize)
  # - maximum: Remove overflow/bounds checks (DANGEROUS - use with caution)
  level: aggressive
  
  # Maximum number of optimization passes before stopping
  # Optimizer runs until no changes or this limit is reached
  # Default: 5
  max_passes: 5

# =============================================================================
# VENOM OPTIMIZATION PASSES (yul2venom.py)
# =============================================================================
# Post-transpilation optimization of Venom IR.
# Runs AFTER IR generation via Vyper's optimization pipeline.

optimization:
  # Optimization level for Venom IR passes:
  # - none: No optimization passes at all
  # - O0: Minimal - only store elimination and SSA conversion
  # - O2: Safe Yul pipeline - balanced optimization
  # - O3/Os: Same as O2 (safe pipeline)
  # - yul-o2: Alias for O2
  # - native: Vyper pipeline via run_passes_on (DEFAULT profile)
  # - debug: Legacy debug pipeline
  level: native

  # Native profile defaults (can still be overridden via env vars):
  #   Y2V_NATIVE_LEVEL
  #   Y2V_NATIVE_DISABLE_MEM2VAR
  #   Y2V_NATIVE_DISABLE_LOAD_ELIMINATION
  native_level: codesize
  native_disable_mem2var: true
  native_disable_load_elimination: false
  
  # DJMP threshold: minimum case count to use O(1) jump table dispatch.
  # Trade-off analysis:
  #   - DJMP overhead: codecopy + mload + djmp â‰ˆ 20 gas setup + 8 gas/jump
  #   - JNZ chain: ~9 gas per comparison (eq + jnz)
  # Break-even point is ~3-4 cases. Tuned default 6 trims init/deploy
  # overhead in current workloads.
  # Lower = more aggressive O(1) dispatch, Higher = more linear search.
  djmp_threshold: 6

# =============================================================================
# MEMORY LAYOUT (utils/constants.py)
# =============================================================================
# Low-level memory addresses used by the Venom backend.
# These values override the defaults in utils/constants.py at runtime.

memory:
  # Where Venom starts allocating memory for stack spills
  # Must be above Vyper scratch space (0x00-0x60) and Solidity FMP (0x40)
  # 0x100 uses PUSH1 (saves ~1 byte per mstore vs PUSH2)
  venom_start: 0x100
  
  # Offset for stack spill operations - safely beyond Yul heap
  spill_offset: 0x4000
  
  # Solidity/Yul free memory pointer slot location
  fmp_slot: 0x40
  
  # Solidity/Yul heap start (after scratch space and FMP)
  heap_start: 0x80

# =============================================================================
# DEBUG OUTPUT
# =============================================================================
# Control what intermediate files are saved for debugging.

debug:
  # Save raw IR (before optimization) to debug/raw_ir.vnm
  save_raw_ir: true
  
  # Save optimized IR to debug/opt_ir.vnm
  save_opt_ir: true
  
  # Save generated assembly to debug/assembly.asm
  save_assembly: true
  
  # Print inlining decisions to stderr during transpilation
  verbose_inlining: true
  
  # Directory for debug output files
  output_dir: debug

# =============================================================================
# OUTPUT PATHS
# =============================================================================

output:
  # Directory for transpiled bytecode binaries
  dir: output
  
  # Suffix added to output filenames (e.g., Contract_opt.bin)
  suffix: _opt

# =============================================================================
# PARSER
# =============================================================================

parser:
  # Python recursion limit for parsing deep Yul AST structures
  # Increase if you get RecursionError on complex contracts
  recursion_limit: 5000

# =============================================================================
# BACKEND
# =============================================================================

backend:
  # Target EVM version for bytecode generation
  evm_version: cancun
  
  # Enable experimental/unstable features
  experimental: false

# =============================================================================
# SAFETY
# =============================================================================
# Control transpiler safety checks and error handling behavior.

safety:
  # If true, dataoffset/datasize/loadimmutable failures raise exceptions
  # instead of returning 0 with a warning.
  # Enable this in CI/production to catch missing object/immutable references.
  # Default: false (backward compatible - warnings only)
  strict_intrinsics: false

  # Optional Solidity/Yul compatibility mode for memoryguard.
  # If true, FMP floor becomes max(memoryguard_arg, venom_start).
  # Default false keeps venom-native floor (venom_start).
  memoryguard_parity: false

# =============================================================================
# PROJECT PATHS
# =============================================================================

paths:
  # Default directory for contract config files
  configs: configs
  
  # Default directory for Solidity source files
  sol_dir: foundry/src
